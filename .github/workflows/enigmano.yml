name: "üè¢ Windows 11 - RPD"

on:
  workflow_dispatch:
    inputs:
      INSTANCE:
        description: "‚å®Ô∏è Numero de instancia [1-10]:"
        required: true
        default: "1"
        type: string

jobs:
  deploy-enigmano:
    name: "Instancia - ${{ github.event.inputs.INSTANCE }}"
    runs-on: windows-latest

    env:
      INSTANCE_ID: ${{ github.event.inputs.INSTANCE }}
      SECRET_SHAHZAIB: ${{ secrets.SECRET_SHAHZAIB }}
      NGROK_SHAHZAIB: ${{ secrets.NGROK_SHAHZAIB }}
      REPO: ${{ github.repository }}
      WORKFLOW_FILE: "enigmano.yml"
      DEPLOYMENT_ID: ${{ github.run_id }}

    steps:
      - name: ü¶à Checkout repo
        uses: actions/checkout@v4

      - name: ü™ô Informacion del sistema
        run: |
          Write-Host "=== ENIGMANO RDP DEPLOYMENT ===" -ForegroundColor Green
          Write-Host "Instance Number: $env:INSTANCE_ID" -ForegroundColor Yellow
          Write-Host "Runner: $env:RUNNER_NAME" -ForegroundColor Yellow
          Write-Host "Workflow: $env:GITHUB_WORKFLOW" -ForegroundColor Yellow
          
          # System specs
          Write-Host "`n=== SYSTEM SPECIFICATIONS ===" -ForegroundColor Cyan
          Get-ComputerInfo | Select-Object WindowsProductName, WindowsVersion, TotalPhysicalMemory
          Get-WmiObject -Class Win32_Processor | Select-Object Name, NumberOfCores, NumberOfLogicalProcessors
        
      - name: ‚öôÔ∏è Parametros
        shell: powershell
        run: |
          # script
          $ProgressPreference = 'SilentlyContinue'
          $prevInstance = [int]$env:INSTANCE_ID - 1
          Write-Host '==============================================='
          Write-Host ("Instancia EnigMano    : {0}" -f $env:INSTANCE_ID)
          Write-Host ("Instancia anterior    : {0}" -f $prevInstance)
          Write-Host ("Repositorio           : {0}" -f $env:REPO)
          Write-Host ("Workflow              : {0}" -f $env:WORKFLOW_FILE)
          Write-Host ("ID de despliegue      : {0}" -f $env:DEPLOYMENT_ID)
          Write-Host '==============================================='

      - name: üîê Validacion tokens
        shell: powershell
        run: |
          # script
          $ProgressPreference = 'SilentlyContinue'
          if (-not $env:NGROK_SHAHZAIB) {
            Write-Error 'Falta el token de Ngrok: NGROK_SHAHZAIB'
            exit 1
          }
          if (-not $env:SECRET_SHAHZAIB) {
            Write-Host 'ADVERTENCIA: SECRET_SHAHZAIB no esta configurado. Se omitira el encadenamiento de la siguiente instancia.'
          }
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          Write-Host ' üìù Tokens verificados'

      - name: üì¶ Instalacion de software
        shell: powershell
        run: |
          # script
          Write-Host 'Instalacion de software'
          $ProgressPreference = 'SilentlyContinue'
          Write-Host 'Preparando Chocolatey...'
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1')) *> $null
          choco --version *> $null
          Write-Host 'Chocolatey listo'

          function Install-App {
            param([string]$Id,[string]$Nombre)
            choco install $Id -y --no-progress *> $null
            $code = $LASTEXITCODE
            if ($code -in 0,3010) { Write-Host ("OK: {0} instalado" -f $Nombre) }
            elseif ($code -eq 0)  { Write-Host ("OK: {0} instalado" -f $Nombre) }
            else { Write-Host ("AVISO: {0} pudo no instalarse correctamente (codigo {1})" -f $Nombre,$code) }
          }

          Install-App -Id 'brave' -Nombre 'Brave'
          Install-App -Id 'winrar' -Nombre 'WinRAR'
          Install-App -Id 'notepadplusplus' -Nombre 'Notepad++'

      - name: ü™ô Extensi√≥n - uBlock Origin (Brave)
        shell: powershell
        run: |
          Write-Host 'Politica uBlock Origin (Brave)'
          $ProgressPreference = 'SilentlyContinue'
          Write-Host 'Aplicando directiva para forzar la instalacion de uBlock Origin en Brave...'
          $policyPath = "HKLM:\Software\Policies\BraveSoftware\Brave\ExtensionInstallForcelist"
          New-Item -Path $policyPath -Force | Out-Null
          New-ItemProperty -Path $policyPath -Name "1" -Value "cjpalhdlnbpafiamejdnhcphjbkeiagm;https://clients2.google.com/service/update2/crx" -PropertyType String -Force | Out-Null
          Write-Host 'Directiva aplicada. uBlock Origin se instalara al iniciar Brave.'

      - name: üñºÔ∏è Fondo de pantalla
        shell: powershell
        run: |
          # script
          $ErrorActionPreference = 'Stop'
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072

          $themeDir = "$env:APPDATA\Microsoft\Windows\Themes"
          New-Item -Path $themeDir -ItemType Directory -Force | Out-Null

          $imgUrl  = "https://static0.gamerantimages.com/wordpress/wp-content/uploads/wm/2025/06/hollow-knight-silksong-hornet-close-up-over-gameplay-screenshot.jpg"
          $imgPath = Join-Path $themeDir "wallpaper.jpg"
          Invoke-WebRequest -Uri $imgUrl -OutFile $imgPath -UseBasicParsing

          # Avoid PowerShell here-strings inside YAML by using -MemberDefinition
          $member = '[DllImport("user32.dll", SetLastError = true)] public static extern bool SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni);'
          Add-Type -Namespace Win32 -Name Native -MemberDefinition "using System.Runtime.InteropServices; public static class Native { $member }"
          Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name Wallpaper -Value $imgPath
          Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name WallpaperStyle -Value 6
          Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name TileWallpaper -Value 0
          [Win32.Native]::SystemParametersInfo(0x0014, 0, $imgPath, 0x0001 -bor 0x0002) | Out-Null

      - name: ‚ö° Ejecucion del script
        shell: powershell
        run: |
          # script
          $ErrorActionPreference = 'Stop'
          Set-Location $env:GITHUB_WORKSPACE

          $candidatePaths = @(
            ".\powershell\EnigMano-instance.ps1",
            ".\EnigMano-instance.ps1"
          )

          $scriptPath = $candidatePaths | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $scriptPath) {
            Write-Error "No se encontr√≥ 'EnigMano-instance.ps1' en el repositorio."
            Get-ChildItem -Path . -Recurse -Filter 'EnigMano-instance.ps1' | Select-Object FullName
            exit 1
          }

          Write-Host ("Ejecutando script: {0}" -f $scriptPath)
          powershell.exe -ExecutionPolicy Bypass -File $scriptPath

      - name: üèÅ Finalizado
        if: always()
        shell: powershell
        run: |
          # script
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          Write-Host 'Developer by Nex'
