 name: "âš¡ Despliegue de Instancia EnigMano"

on:
  workflow_dispatch:
    inputs:
      INSTANCE:
        description: "NÃºmero de instancia a desplegar (p. ej., 1, 2, 3...)"
        required: true
        default: "1"
        type: string

jobs:
  deploy-enigmano:
    name: "ğŸš€ Desplegar instancia EnigMano #${{ github.event.inputs.INSTANCE }}"
    runs-on: windows-latest

    env:
      INSTANCE_ID: ${{ github.event.inputs.INSTANCE }}
      SECRET_SHAHZAIB: ${{ secrets.SECRET_SHAHZAIB }}
      NGROK_SHAHZAIB: ${{ secrets.NGROK_SHAHZAIB }}
      REPO: ${{ github.repository }}
      WORKFLOW_FILE: "enigmano.yml"
      DEPLOYMENT_ID: ${{ github.run_id }}

    steps:
      - name: "ğŸ“Œ ParÃ¡metros del despliegue â€” Instancia #${{ env.INSTANCE_ID }}"
        shell: pwsh
        run: |
          $prevInstance = [int]$env:INSTANCE_ID - 1
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "ğŸ”¹ Instancia EnigMano    : $env:INSTANCE_ID"
          Write-Host "ğŸ”¢ Instancia anterior    : $prevInstance"
          Write-Host "ğŸ“¦ Repositorio de GitHub : $env:REPO"
          Write-Host "ğŸ” Workflow de despliegue: $env:WORKFLOW_FILE"
          Write-Host "ğŸ†” ID de despliegue      : $env:DEPLOYMENT_ID"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ğŸ” Validar secretos (GitHub y Ngrok)
        shell: pwsh
        run: |
          if (-not $env:SECRET_SHAHZAIB) {
            Write-Error "âŒ Falta el secreto de GitHub: SECRET_SHAHZAIB"
            exit 1
          }
          if (-not $env:NGROK_SHAHZAIB) {
            Write-Error "âŒ Falta el token de autenticaciÃ³n de Ngrok: NGROK_SHAHZAIB"
            exit 1
          }
          Write-Host "âœ… Todos los secretos requeridos fueron validados correctamente"

      - name: ğŸ†” Generar identidad y credenciales seguras
        shell: pwsh
        run: |
          function New-SecurePassword {
            $upper   = [char[]](65..90)
            $lower   = [char[]](97..122)
            $number  = [char[]](48..57)
            $specialAll = ([char[]](33..47) + [char[]](58..64) + [char[]](91..96) + [char[]](123..126))
            $excluded = @('"', "'", '`', '&', '|', '<', '>', '$', ' ') # excluir comillas, backtick, pipe, redirecciones, espacio, dÃ³lar
            $special = $specialAll | Where-Object { $excluded -notcontains $_ }
            $raw = @()
            $raw += $upper   | Get-Random -Count 4
            $raw += $lower   | Get-Random -Count 4
            $raw += $number  | Get-Random -Count 4
            $raw += $special | Get-Random -Count 4
            -join ($raw | Sort-Object { Get-Random })
          }

          $suffix = -join ((48..57 + 97..122) | Get-Random -Count 4 | ForEach-Object {[char]$_})
          $instanceLabel = "ENIG-$($env:INSTANCE_ID)-$suffix"
          $username = "rdp-$suffix"
          $password = New-SecurePassword

          Write-Host "::add-mask::$password"
          Add-Content -Path $env:GITHUB_ENV -Value "RDP_USER=$username"
          Add-Content -Path $env:GITHUB_ENV -Value "RDP_PASS=$password"
          Add-Content -Path $env:GITHUB_ENV -Value "INSTANCE_LABEL=$instanceLabel"

          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "ğŸ†” Identidad generada"
          Write-Host " â€¢ Usuario      : $username"
          Write-Host " â€¢ Etiqueta     : $instanceLabel"
          Write-Host " â€¢ ContraseÃ±a   : (oculta)"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ğŸ“¦ Instalar software con Chocolatey (Brave, WinRAR, Notepad++)
        shell: pwsh
        run: |
          Write-Host "ğŸ“¥ Instalando Chocolatey y aplicaciones..." -ForegroundColor Green
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

          choco --version

          # Instalar aplicaciones (idempotente)
          choco install brave -y --no-progress || Write-Host "â„¹ï¸ InstalaciÃ³n de Brave omitida (posiblemente ya instalado)."
          choco install winrar -y --no-progress || Write-Host "â„¹ï¸ InstalaciÃ³n de WinRAR omitida (posiblemente ya instalado)."
          choco install notepadplusplus -y --no-progress || Write-Host "â„¹ï¸ InstalaciÃ³n de Notepad++ omitida (posiblemente ya instalado)."

      - name: ğŸ§© Forzar instalaciÃ³n de uBlock Origin en Brave
        shell: pwsh
        run: |
          Write-Host "ğŸ›¡ï¸ Configurando directiva para forzar la instalaciÃ³n de uBlock Origin en Brave..." -ForegroundColor Green
          $policyPath = "HKLM:\Software\Policies\BraveSoftware\Brave\ExtensionInstallForcelist"
          New-Item -Path $policyPath -Force | Out-Null
          New-ItemProperty -Path $policyPath -Name "1" -Value "cjpalhdlnbpafiamejdnhcphjbkeiagm;https://clients2.google.com/service/update2/crx" -PropertyType String -Force | Out-Null
          Write-Host "âœ… Directiva aplicada. uBlock Origin se instalarÃ¡ cuando se inicie Brave." -ForegroundColor Green

      - name: ğŸ“¥ Descargar EnigMano-instance.ps1 (del repo actual)
        shell: pwsh
        run: |
          $repo = "$env:REPO"
          $branch = $env:GITHUB_REF_NAME
          if ([string]::IsNullOrWhiteSpace($branch)) { $branch = "main" }
          $url = "https://raw.githubusercontent.com/$repo/$branch/powershell/EnigMano-instance.ps1"
          Write-Host "ğŸŒ Descargando EnigMano-instance.ps1 desde:"
          Write-Host "   $url"
          Invoke-WebRequest -Uri $url -OutFile "EnigMano-instance.ps1" -UseBasicParsing
          if (!(Test-Path "./EnigMano-instance.ps1")) {
            Write-Error "âŒ No se pudo descargar EnigMano-instance.ps1 desde el repositorio actual ($repo)."
            exit 1
          }
          Write-Host "âœ… EnigMano-instance.ps1 descargado correctamente"

      - name: ğŸ§­ Ejecutar script de instancia EnigMano (con parÃ¡metros)
        shell: pwsh
        run: |
          Write-Host "ğŸš¦ Iniciando EnigMano-instance.ps1 con credenciales generadas"
          powershell.exe -ExecutionPolicy Bypass -File ".\EnigMano-instance.ps1" -Username "$env:RDP_USER" -Password "$env:RDP_PASS" -InstanceLabel "$env:INSTANCE_LABEL"

      - name: âœ… Estado final
        if: always()
        shell: pwsh
        run: |
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "ğŸ‰ Despliegue completado"
          Write-Host " â€¢ Instancia    : $env:INSTANCE_ID"
          Write-Host " â€¢ Usuario RDP  : $env:RDP_USER"
          Write-Host " â€¢ Etiqueta     : $env:INSTANCE_LABEL"
          Write-Host "ğŸ”‹ Impulsado por: SHAHZAIB-YT"
          Write-Host "ğŸ Despliegue de EnigMano ejecutado con precisiÃ³n."
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
