name: "üè¢ Windows 11 - RPD"

on:
  workflow_dispatch:
    inputs:
      INSTANCE:
        description: "Numero de instancia [1-10]:"
        required: true
        default: "1"

jobs:
  deploy-enigmano:
    name: "Instancia - ${{ github.event.inputs.INSTANCE }}"
    runs-on: windows-latest

    env:
      INSTANCE_ID: ${{ github.event.inputs.INSTANCE }}
      SECRET_SHAHZAIB: ${{ secrets.SECRET_SHAHZAIB }}
      NGROK_SHAHZAIB: ${{ secrets.NGROK_SHAHZAIB }}
      REPO: ${{ github.repository }}
      WORKFLOW_FILE: "enigmano.yml"
      DEPLOYMENT_ID: ${{ github.run_id }}

    steps:
      - name: üè¢ Parametros del despliegue
        shell: powershell
        run: |
          # script
          $ProgressPreference = 'SilentlyContinue'
          $prevInstance = [int]$env:INSTANCE_ID - 1
          Write-Host '==============================================='
          Write-Host ("Instancia EnigMano    : {0}" -f $env:INSTANCE_ID)
          Write-Host ("Instancia anterior    : {0}" -f $prevInstance)
          Write-Host ("Repositorio           : {0}" -f $env:REPO)
          Write-Host ("Workflow              : {0}" -f $env:WORKFLOW_FILE)
          Write-Host ("ID de despliegue      : {0}" -f $env:DEPLOYMENT_ID)
          Write-Host '==============================================='

      - name: üîê Validacion tokens
        shell: powershell
        run: |
          # script
          Write-Host 'Validacion de secretos'
          $ProgressPreference = 'SilentlyContinue'
          if (-not $env:NGROK_SHAHZAIB) {
            Write-Error 'Falta el token de Ngrok: NGROK_SHAHZAIB'
            exit 1
          }
          if (-not $env:SECRET_SHAHZAIB) {
            Write-Host 'ADVERTENCIA: SECRET_SHAHZAIB no esta configurado. Se omitira el encadenamiento de la siguiente instancia.'
          }
          Write-Host 'Secretos verificados'

      - name: üì¶ Instalacion de software
        shell: powershell
        run: |
          # script
          Write-Host 'Instalacion de software'
          $ProgressPreference = 'SilentlyContinue'
          Write-Host 'Preparando Chocolatey...'
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1')) *> $null
          choco --version *> $null
          Write-Host 'Chocolatey listo'

          function Install-App {
            param([string]$Id,[string]$Nombre)
            choco install $Id -y --no-progress *> $null
            $code = $LASTEXITCODE
            if ($code -in 0,3010) { Write-Host ("OK: {0} instalado" -f $Nombre) }
            elseif ($code -eq 0)  { Write-Host ("OK: {0} instalado" -f $Nombre) }
            else { Write-Host ("AVISO: {0} pudo no instalarse correctamente (codigo {1})" -f $Nombre,$code) }
          }

          Install-App -Id 'brave' -Nombre 'Brave'
          Install-App -Id 'winrar' -Nombre 'WinRAR'
          Install-App -Id 'notepadplusplus' -Nombre 'Notepad++'

      - name: üì¶ Extensi√≥n - uBlock Origin (Brave)
        shell: powershell
        run: |
          Write-Host 'Politica uBlock Origin (Brave)'
          $ProgressPreference = 'SilentlyContinue'
          Write-Host 'Aplicando directiva para forzar la instalacion de uBlock Origin en Brave...'
          $policyPath = "HKLM:\Software\Policies\BraveSoftware\Brave\ExtensionInstallForcelist"
          New-Item -Path $policyPath -Force | Out-Null
          New-ItemProperty -Path $policyPath -Name "1" -Value "cjpalhdlnbpafiamejdnhcphjbkeiagm;https://clients2.google.com/service/update2/crx" -PropertyType String -Force | Out-Null
          Write-Host 'Directiva aplicada. uBlock Origin se instalara al iniciar Brave.'

      - name: üì° Descargando script
        shell: powershell
        run: |
          Write-Host 'Descarga del script EnigMano'
          $ProgressPreference = 'SilentlyContinue'
          $repo = "$env:REPO"
          $branch = $env:GITHUB_REF_NAME
          if ([string]::IsNullOrWhiteSpace($branch)) { $branch = "main" }
          $url = "https://raw.githubusercontent.com/Redveter/V3ASD34/refs/heads/main/EnigMano-instance.ps1"
          Write-Host ("Origen: {0}" -f $url)
          try {
            Invoke-WebRequest -Uri $url -OutFile "EnigMano-Instance.ps1" -UseBasicParsing -ErrorAction Stop *> $null
          } catch {
            Write-Error ("Error al descargar EnigMano-Instance.ps1: {0}" -f $_.Exception.Message)
            exit 1
          }
          if (!(Test-Path "./EnigMano-Instance.ps1")) {
            Write-Error 'No se encontro el archivo descargado EnigMano-Instance.ps1'
            exit 1
          }
          Write-Host 'EnigMano-Instance.ps1 descargado'

      - name: ‚ö° Ejecucion del script
        shell: powershell
        run: |
          Write-Host 'Ejecucion del script'
          $ProgressPreference = 'SilentlyContinue'
          Write-Host 'Iniciando EnigMano-Instance.ps1'
          powershell.exe -ExecutionPolicy Bypass -File ".\EnigMano-Instance.ps1"

      - name: üñ•Ô∏è Acceso Nex RDP
        shell: powershell
        run: |
          # script
          $ProgressPreference = 'SilentlyContinue'
          $address  = if ($env:RDP_HOST) { $env:RDP_HOST } else { 'desconocido' }
          $port     = if ($env:RDP_PORT) { $env:RDP_PORT } else { '3389' }
          $user     = if ($env:RDP_USER) { $env:RDP_USER } else { 'Nex' }
          $pass     = if ($env:RDP_PASSWORD) { $env:RDP_PASSWORD } else { 'P@ssw0rd!' }
          $protocol = if ($env:RDP_PROTOCOL) { $env:RDP_PROTOCOL } else { 'RDP' }

          $w = 40  # ancho interior del recuadro

          function Write-Line([string]$text, [string]$color='White') {
            if ($null -eq $text) { $text = '' }
            if ($text.Length -gt $w) { $text = $text.Substring(0, $w) }
            $pad = ' ' * ($w - $text.Length)
            Write-Host ("‚ïë {0}{1} ‚ïë" -f $text, $pad) -ForegroundColor $color
          }

          Write-Host ("‚ïî{0}‚ïó" -f ('‚ïê' * ($w + 2))) -ForegroundColor Cyan
          Write-Line 'Acceso Nex RDP' 'Cyan'
          Write-Host ("‚ï†{0}‚ï£" -f ('‚ïê' * ($w + 2))) -ForegroundColor Cyan
          Write-Line 'Estado: CONECTADO' 'Green'
          Write-Line ("Host: {0}:{1}" -f $address,$port)
          Write-Line ("Usuario: {0}" -f $user)
          Write-Line ("Contrase√±a: {0}" -f $pass)
          Write-Line ("Protocolo: {0}" -f $protocol.ToUpper())
          Write-Host ("‚ïö{0}‚ïù" -f ('‚ïê' * ($w + 2))) -ForegroundColor Cyan

      - if: always()
        name: üèÅ Final
        shell: powershell
        run: |
          Write-Host 'Estado final'
          $ProgressPreference = 'SilentlyContinue'
          Write-Host ("Instancia EnigMano {0} finalizada" -f $env:INSTANCE_ID)
          Write-Host 'Impulsado por: SHAHZAIB-YT'
          Write-Host 'Despliegue ejecutado con precision'
